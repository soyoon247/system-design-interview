# 5. 안정 해시 설계
수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. -> **안정해시**를 이용하여 해결

### 기존 해시 방식의 문제
보편적 방법 : N대의 서버에 부하를 균등하게 나누기 위해 해시 함수를 이용
`serverIndex = hash(key) % N`

-> 서버가 추가되거나 기존 서버가 삭제되면 문제가 생김. 1개의 서버만 삭제되어도 대규모 캐시 미스 발생

### 안정 해시로 해결
안정해시 = 해시 테이블 크기가 조정될 때 평균적으로 k/n 개의 키만 재배치하는 해시 기술 (k = 키의 개수, n은 서버 개수)

- 해시 공간을 구부려 접어서 해시 링을 만들고, 해시 함수를 이용해 각 서버와 키들을 해시 링 위에 배치한다. (위의 방법처럼 수가 제한되어 있는 나머지 값을 사용하는 방법이 아님)
-  해당 키의 위치로부터 시계방향으로 링을 탐색하면서 만나는 첫번째 서버에 값을 저장한다. 

-> 서버를 추가 / 삭제하여도 키 가운데 일부만 재배치된다.


### 또 다른 문제
- 서버가 추가 / 삭제된다면 파티션의 크기가 불균등해진다. 
- 키의 균등 분포도 어려워진다. 

### 가상 노드(또는 replica)로 해결
- 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있으며, 가상 노드의 개수를 늘릴 수록 키의 분포는 균등해진다. 
- 가상 노드의 개수를 늘리면 편차가 줄어드는 대신, 저장 공간이 많이 필요하므로 tradeoff



